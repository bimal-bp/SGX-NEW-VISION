<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SGX Minerals - Login</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * { margin:0; padding:0; box-sizing:border-box; font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif; }
        body { background:linear-gradient(135deg,#0c0c0c 0%,#1a1a2e 100%); color:#f0f0f0; min-height:100vh; display:flex; justify-content:center; align-items:center; overflow-x:hidden; }
        .container { display:flex; width:900px; height:550px; background:rgba(20,20,30,.9); border-radius:20px; overflow:hidden; box-shadow:0 15px 35px rgba(0,0,0,.5); position:relative; }
        .camera-section { flex:1; display:flex; flex-direction:column; justify-content:center; align-items:center; background:linear-gradient(45deg,#0f0f1a 0%,#1a1a2e 100%); padding:20px; }
        .camera-container { width:300px; height:300px; border-radius:10px; overflow:hidden; position:relative; box-shadow:0 0 20px rgba(0,0,0,.5); }
        #cameraPreview { width:100%; height:100%; object-fit:cover; background:#2a2a4a; }
        .capture-overlay { position:absolute; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,.7); display:flex; justify-content:center; align-items:center; opacity:0; pointer-events:none; transition:opacity .3s ease; }
        .capture-overlay.active { opacity:1; pointer-events:auto; }
        .capture-animation { width:100px; height:100px; border:5px solid #64ff96; border-radius:50%; animation:pulse 1.5s infinite; }
        @keyframes pulse { 0%{transform:scale(.8);opacity:1} 100%{transform:scale(1.5);opacity:0} }
        .login-section { flex:1; display:flex; flex-direction:column; justify-content:center; align-items:center; padding:40px; position:relative; }
        .company-title { font-size:32px; font-weight:700; margin-bottom:10px; color:#ff8c00; text-align:center; }
        .company-subtitle { font-size:16px; color:#b0b0d0; margin-bottom:40px; text-align:center; }
        .login-form { width:100%; max-width:320px; padding:30px; background:rgba(30,30,46,.8); border-radius:15px; box-shadow:0 10px 25px rgba(0,0,0,.3); transition:box-shadow .5s ease; position:relative; z-index:2; }
        .login-form.glow { box-shadow:0 0 20px rgba(100,255,150,.5); }
        h2 { text-align:center; margin-bottom:30px; font-weight:600; color:#a0f0c0; font-size:28px; }
        .input-group { margin-bottom:20px; position:relative; }
        label { display:block; margin-bottom:8px; font-size:14px; color:#b0b0d0; }
        input { width:100%; padding:12px 15px; background:rgba(40,40,60,.8); border:1px solid #4a4a7a; border-radius:8px; color:#f0f0f0; font-size:16px; transition:all .3s ease; }
        input:focus { outline:none; border-color:#64ff96; box-shadow:0 0 10px rgba(100,255,150,.3); }
        .login-btn { width:100%; padding:12px; background:linear-gradient(135deg,#64ff96 0%,#2ecc71 100%); border:none; border-radius:8px; color:#1a1a2e; font-size:16px; font-weight:600; cursor:pointer; transition:all .3s ease; margin-top:10px; display:flex; justify-content:center; align-items:center; gap:8px; }
        .login-btn:hover:not(:disabled) { transform:translateY(-2px); box-shadow:0 5px 15px rgba(100,255,150,.4); }
        .login-btn:disabled { background:#555; cursor:not-allowed; opacity:0.7; }
        .forgot-password { text-align:center; margin-top:20px; }
        .forgot-password a { color:#64ff96; text-decoration:none; font-size:14px; transition:color .3s ease; }
        .forgot-password a:hover { color:#a0f0c0; text-decoration:underline; }
        .decoration { position:absolute; width:200px; height:200px; border-radius:50%; background:radial-gradient(circle,rgba(100,255,150,.1) 0%,rgba(100,255,150,0) 70%); z-index:1; }
        .decoration:nth-child(1){top:-50px;right:-50px;width:150px;height:150px;}
        .decoration:nth-child(2){bottom:-80px;left:-80px;width:200px;height:200px;}
        .camera-info { margin-top:15px; text-align:center; font-size:14px; color:#b0b0d0; }
        .location-status { margin-top:10px; text-align:center; font-size:14px; display:flex; align-items:center; justify-content:center; gap:6px; }
        .location-status i { font-size:16px; }
        .location-status.success { color:#64ff96; }
        .location-status.error { color:#ff6464; }
        .location-status.waiting { color:#b0b0d0; }
        .location-status.warning { color:#ffa500; }
        .retry-btn { margin-top:12px; padding:8px 16px; background:#64ff96; color:#1a1a2e; border:none; border-radius:6px; cursor:pointer; font-weight:600; font-size:14px; display:flex; align-items:center; gap:6px; }
        .retry-btn:hover { background:#2ecc71; }
        .spinner { width:16px; height:16px; border:2px solid #b0b0d0; border-top-color:#64ff96; border-radius:50%; animation:spin 1s linear infinite; }
        @keyframes spin { to { transform:rotate(360deg); } }
        .location-options { margin-top:10px; display:flex; flex-direction:column; gap:8px; }
        .location-option { padding:8px 12px; background:rgba(40,40,60,.8); border:1px solid #4a4a7a; border-radius:6px; color:#f0f0f0; cursor:pointer; transition:all .3s ease; text-align:center; font-size:14px; }
        .location-option:hover { background:rgba(60,60,80,.8); border-color:#64ff96; }
        .location-option i { margin-right:6px; }
       
        /* Company Logo */
        .company-logo-container { position: absolute; top: 20px; left: 20px; display: flex; align-items: center; gap: 10px; }
        .company-logo { width: 60px; height: 60px; object-fit: cover; border: 2px solid #ff8c00; border-radius: 8px; box-shadow: 0 0 10px rgba(255,140,0,.3); }
        .company-name { font-size: 20px; font-weight: 700; color: #ff8c00; }
        /* Dashboard */
        .dashboard { display:none; width:100%; height:100vh; background:linear-gradient(135deg,#0c0c0c 0%,#1a1a2e 100%); color:#f0f0f0; padding:20px; }
        .dashboard-header { display:flex; justify-content:space-between; align-items:center; padding:20px; background:rgba(20,20,30,.8); border-radius:15px; margin-bottom:30px; box-shadow:0 10px 25px rgba(0,0,0,.3); }
        .welcome-message { font-size:24px; font-weight:600; background:linear-gradient(135deg,#64ff96 0%,#2ecc71 100%); -webkit-background-clip:text; background-clip:text; color:transparent; }
        .dashboard-logout { padding:10px 20px; background:linear-gradient(135deg,#64ff96 0%,#2ecc71 100%); border:none; border-radius:8px; color:#1a1a2e; font-size:16px; font-weight:600; cursor:pointer; transition:all .3s ease; display:flex; align-items:center; gap:8px; }
        .dashboard-logout:hover { transform:translateY(-2px); box-shadow:0 5px 15px rgba(100,255,150,.4); }
        .dashboard-content { display:grid; grid-template-columns:repeat(auto-fit,minmax(300px,1fr)); gap:20px; padding:20px; }
        .dashboard-card { background:rgba(20,20,30,.8); border-radius:15px; padding:20px; box-shadow:0 10px 25px rgba(0,0,0,.3); transition:transform .3s ease; }
        .dashboard-card:hover { transform:translateY(-5px); }
        .dashboard-card h3 { font-size:18px; margin-bottom:15px; color:#a0f0c0; }
        .dashboard-card p { color:#b0b0d0; line-height:1.6; }
        .captured-photo-container { margin:20px 0; max-width:600px; text-align:left; padding:20px; background:rgba(20,20,30,.8); border-radius:15px; box-shadow:0 10px 25px rgba(0,0,0,.3); }
        .captured-photo { max-width:100%; max-height:300px; border-radius:8px; margin-top:10px; border:2px solid #64ff96; }
        .login-record { margin-top:15px; padding:15px; background:rgba(30,30,46,.7); border-radius:10px; text-align:left; font-size:14px; }
        .login-record h4 { color:#64ff96; margin-bottom:10px; }
        .login-record p { margin:6px 0; color:#b0b0d0; }
        .location-display { color: #64ff96; font-weight: 600; margin-top: 10px; }
        @media (max-width:768px){
            .container{flex-direction:column;width:90%;height:auto;}
            .camera-section{padding:40px 0;}
            .login-section{padding:20px;}
            .dashboard-header{flex-direction:column;gap:15px;text-align:center;}
            .company-logo-container { position: relative; top: 0; left: 0; justify-content: center; margin-bottom: 20px; }
        }
        .card-header { background-color: #FF7A00; color: white; }
        .editable { cursor: pointer; font-family: monospace; }
        .error { border-color: red; }
        th.sticky { position: sticky; top: 0; background: white; z-index: 10; }
        .sparkline { width: 100px; height: 20px; background: linear-gradient(to right, #ddd, #aaa); }
        .big-button { display: block; margin: 20px auto; padding: 20px 40px; background:linear-gradient(135deg,#64ff96 0%,#2ecc71 100%); color:#1a1a2e; font-size:24px; font-weight:600; border-radius:50%; text-align:center; cursor:pointer; transition:all .3s ease; box-shadow:0 5px 15px rgba(100,255,150,.4); width:200px; height:200px; display:flex; justify-content:center; align-items:center; text-decoration:none; }
        .big-button:hover { transform:translateY(-2px); box-shadow:0 10px 20px rgba(100,255,150,.6); }
    </style>
</head>
<body>
    <!-- Login Page -->
    <div class="container" id="loginPage">
        <div class="company-logo-container">
            <img src="https://raw.githubusercontent.com/bimal-bp/Work_plan/main/Company_logo" alt="Company Logo" class="company-logo">
        </div>
       
        <div class="camera-section">
            <div class="camera-container">
                <video id="cameraPreview" autoplay muted playsinline></video>
                <div class="capture-overlay" id="captureOverlay">
                    <div class="capture-animation"></div>
                </div>
            </div>
            <div class="camera-info">Camera will capture your photo upon login</div>
            <div class="location-status waiting" id="locationStatus">
                <div class="spinner"></div> Getting your location…
            </div>
            <div class="location-options" id="locationOptions" style="display:none;">
                <button class="location-option" id="retryLocation">
                    Retry High Accuracy Location
                </button>
                <button class="location-option" id="useApproximateLocation">
                    Use Approximate Location
                </button>
                <button class="location-option" id="skipLocation">
                    Skip Location (Limited Access)
                </button>
            </div>
        </div>
        <div class="login-section">
            <div class="decoration"></div>
            <div class="decoration"></div>
            <h1 class="company-title">SGX MINERALS PVT LTD</h1>
            <p class="company-subtitle">Resource Management System</p>
            <form class="login-form" id="loginForm">
                <h2>Welcome Back</h2>
                <div class="input-group">
                    <label for="username">Username</label>
                    <input type="text" id="username" placeholder="Enter your username" required>
                </div>
                <div class="input-group">
                    <label for="password">Password</label>
                    <input type="password" id="password" placeholder="Enter your password" required>
                </div>
                <button type="submit" class="login-btn" id="loginBtn" disabled>
                    Login
                </button>
                <div class="forgot-password"><a href="#">Forgot Password?</a></div>
            </form>
        </div>
    </div>

    <!-- Dashboard Page -->
    <div class="dashboard" id="dashboardPage">
        <div class="dashboard-header">
            <div class="welcome-message" id="welcomeMessage">Welcome, Bimal Patra!</div>
            <button class="dashboard-logout" id="logoutBtn">
                Logout
            </button>
        </div>

        <!-- Login Security Record -->
        <div class="dashboard-content">
            <div class="captured-photo-container">
                <h3>Login Security Record</h3>
                <img id="capturedPhoto" class="captured-photo" src="" alt="Captured login photo">
                <div class="login-record" id="loginRecord">
                    <h4>Login Details:</h4>
                    <div id="loginDetails"></div>
                    <p class="location-display" id="locationName">Madhura Nagar, Vengal Rao Nagar, Ward 99 Vengal Rao Nagar, Greater Hyderabad Municipal Corporation Central Zone, Hyderabad, Khairatabad mandal, Hyderabad, Telangana, 500073, India</p>
                </div>
            </div>
        </div>

        <!-- Daily Production & Dispatch Dashboard -->
        <div class="max-w-7xl mx-auto">
            <h1 class="text-2xl font-bold text-center mb-4">Daily Production & Dispatch Dashboard — Date: <span id="dashboard-date">01-11-2025</span></h1>
           
            <!-- Top Action Bar -->
            <div class="flex flex-col md:flex-row justify-between items-center mb-6 bg-white p-4 rounded-lg shadow">
                <div class="flex items-center">
                    <label for="date-input" class="mr-2">Date:</label>
                    <input type="text" id="date-input" value="01-11-2025" class="border rounded p-1" onchange="updateDate(this.value)">
                </div>
                <div class="flex space-x-2 mt-2 md:mt-0">
                    <button onclick="exportCSV()" class="bg-blue-500 text-white px-4 py-2 rounded">Export CSV</button>
                    <button onclick="exportExcel()" class="bg-green-500 text-white px-4 py-2 rounded">Export Excel</button>
                    <button onclick="printDashboard()" class="bg-gray-500 text-white px-4 py-2 rounded">Print</button>
                </div>
            </div>
           
            <!-- Responsive Grid -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
               
                <!-- Production Summary -->
                <div class="bg-white p-4 rounded-lg shadow">
                    <h2 class="card-header text-lg font-semibold p-2 rounded-t-lg">Production Summary</h2>
                    <table class="w-full border-collapse">
                        <thead>
                            <tr>
                                <th class="border p-2 sticky">Metric</th>
                                <th class="border p-2 sticky">FTD</th>
                                <th class="border p-2 sticky">MTD</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr><td class="border p-2">Mine Production</td><td class="border p-2"><span class="editable" contenteditable="true" data-type="number" onblur="validateAndUpdate(this)"></span></td><td class="border p-2"><span class="editable" contenteditable="true" data-type="number" onblur="validateAndUpdate(this)"></span></td></tr>
                            <tr><td class="border p-2">Boulder Dispatch QTY</td><td class="border p-2"><span class="editable" contenteditable="true" data-type="number" onblur="validateAndUpdate(this)"></span></td><td class="border p-2"><span class="editable" contenteditable="true" data-type="number" onblur="validateAndUpdate(this)"></span></td></tr>
                            <tr><td class="border p-2">Plant Production</td><td class="border p-2"><span class="editable" contenteditable="true" data-type="number" onblur="validateAndUpdate(this)"></span></td><td class="border p-2"><span class="editable" contenteditable="true" data-type="number" onblur="validateAndUpdate(this)"></span></td></tr>
                            <tr><td class="border p-2">Dispatch QTY</td><td class="border p-2"><span class="editable" contenteditable="true" data-type="number" onblur="validateAndUpdate(this)"></span></td><td class="border p-2"><span class="editable" contenteditable="true" data-type="number" onblur="validateAndUpdate(this)"></span></td></tr>
                            <tr><td class="border p-2">Basic Revenue</td><td class="border p-2"><span class="editable" contenteditable="true" data-type="number" onblur="validateAndUpdate(this)"></span></td><td class="border p-2"><span class="editable" contenteditable="true" data-type="number" onblur="validateAndUpdate(this)"></span></td></tr>
                            <tr><td class="border p-2">Total Revenue</td><td class="border p-2"><span class="editable" contenteditable="true" data-type="number" onblur="validateAndUpdate(this)"></span></td><td class="border p-2"><span class="editable" contenteditable="true" data-type="number" onblur="validateAndUpdate(this)"></span></td></tr>
                        </tbody>
                    </table>
                </div>
               
                <!-- Royalty Requirement & Dispatch Planning -->
                <div class="bg-white p-4 rounded-lg shadow">
                    <h2 class="card-header text-lg font-semibold p-2 rounded-t-lg">Royalty Requirement & Dispatch Planning</h2>
                    <table class="w-full border-collapse" id="royalty-table">
                        <thead>
                            <tr>
                                <th class="border p-2 sticky">Materiel</th>
                                <th class="border p-2 sticky">10MM</th>
                                <th class="border p-2 sticky">20MM</th>
                                <th class="border p-2 sticky">40MM</th>
                                <th class="border p-2 sticky">40–65MM</th>
                                <th class="border p-2 sticky">Msand</th>
                                <th class="border p-2 sticky">GSB</th>
                                <th class="border p-2 sticky">Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td class="border p-2">Royalty Balance in MDL (Tons)</td>
                                <td class="border p-2"><span class="editable" contenteditable="true" data-type="number" onblur="validateAndUpdate(this)"></span></td>
                                <td class="border p-2"><span class="editable" contenteditable="true" data-type="number" onblur="validateAndUpdate(this)"></span></td>
                                <td class="border p-2"><span class="editable" contenteditable="true" data-type="number" onblur="validateAndUpdate(this)"></span></td>
                                <td class="border p-2"><span class="editable" contenteditable="true" data-type="number" onblur="validateAndUpdate(this)"></span></td>
                                <td class="border p-2"><span class="editable" contenteditable="true" data-type="number" onblur="validateAndUpdate(this)"></span></td>
                                <td class="border p-2"><span class="editable" contenteditable="true" data-type="number" onblur="validateAndUpdate(this)"></span></td>
                                <td class="border p-2 font-bold" id="royalty-total">0</td>
                            </tr>
                            <tr>
                                <td class="border p-2 font-bold" colspan="7">Grand Total</td>
                                <td class="border p-2 font-bold" id="royalty-grand-total">0</td>
                            </tr>
                        </tbody>
                    </table>
                   
                    <!-- Blasting Details -->
                    <div class="mt-4">
                        <h3 class="font-semibold mb-2">Blasting Details</h3>
                        <table class="w-full border-collapse">
                            <thead>
                                <tr>
                                    <th class="border p-2">No. of Holes</th>
                                    <th class="border p-2">Total Feetage</th>
                                    <th class="border p-2">Blasting (Yes/No)</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td class="border p-2"><span class="editable" contenteditable="true" data-type="number" onblur="validateAndUpdate(this)"></span></td>
                                    <td class="border p-2"><span class="editable" contenteditable="true" data-type="number" onblur="validateAndUpdate(this)"></span></td>
                                    <td class="border p-2">
                                        <select class="w-full p-1 border rounded" onchange="validateAndUpdate(this)">
                                            <option value=""></option>
                                            <option value="Yes">Yes</option>
                                            <option value="No">No</option>
                                        </select>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
               
                <!-- Today's Dispatch Plan in Tons -->
                <div class="bg-white p-4 rounded-lg shadow md:col-span-2">
                    <h2 class="card-header text-lg font-semibold p-2 rounded-t-lg">Today's Dispatch Plan in Tons</h2>
                    <table class="w-full border-collapse" id="dispatch-table">
                        <thead>
                            <tr>
                                <th class="border p-2 sticky">Customer</th>
                                <th class="border p-2 sticky">10MM</th>
                                <th class="border p-2 sticky">20MM</th>
                                <th class="border p-2 sticky">40MM</th>
                                <th class="border p-2 sticky">40–65MM</th>
                                <th class="border p-2 sticky">Msand</th>
                                <th class="border p-2 sticky">GSB</th>
                                <th class="border p-2 sticky">Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr><td class="border p-2">Aravind Techno</td><td class="border p-2"><span class="editable" contenteditable="true" data-type="number" onblur="validateAndUpdate(this)"></span></td><td class="border p-2"><span class="editable" contenteditable="true" data-type="number" onblur="validateAndUpdate(this)"></span></td><td class="border p-2"><span class="editable" contenteditable="true" data-type="number" onblur="validateAndUpdate(this)"></span></td><td class="border p-2"><span class="editable" contenteditable="true" data-type="number" onblur="validateAndUpdate(this)"></span></td><td class="border p-2"><span class="editable" contenteditable="true" data-type="number" onblur="validateAndUpdate(this)"></span></td><td class="border p-2"><span class="editable" contenteditable="true" data-type="number" onblur="validateAndUpdate(this)"></span></td><td class="border p-2 font-bold">0</td></tr>
                            <tr><td class="border p-2">Chenderu & Co</td><td class="border p-2"><span class="editable" contenteditable="true" data-type="number" onblur="validateAndUpdate(this)"></span></td><td class="border p-2"><span class="editable" contenteditable="true" data-type="number" onblur="validateAndUpdate(this)"></span></td><td class="border p-2"><span class="editable" contenteditable="true" data-type="number" onblur="validateAndUpdate(this)"></span></td><td class="border p-2"><span class="editable" contenteditable="true" data-type="number" onblur="validateAndUpdate(this)"></span></td><td class="border p-2"><span class="editable" contenteditable="true" data-type="number" onblur="validateAndUpdate(this)"></span></td><td class="border p-2"><span class="editable" contenteditable="true" data-type="number" onblur="validateAndUpdate(this)"></span></td><td class="border p-2 font-bold">0</td></tr>
                            <tr><td class="border p-2">Afcon Projects</td><td class="border p-2"><span class="editable" contenteditable="true" data-type="number" onblur="validateAndUpdate(this)"></span></td><td class="border p-2"><span class="editable" contenteditable="true" data-type="number" onblur="validateAndUpdate(this)"></span></td><td class="border p-2"><span class="editable" contenteditable="true" data-type="number" onblur="validateAndUpdate(this)"></span></td><td class="border p-2"><span class="editable" contenteditable="true" data-type="number" onblur="validateAndUpdate(this)"></span></td><td class="border p-2"><span class="editable" contenteditable="true" data-type="number" onblur="validateAndUpdate(this)"></span></td><td class="border p-2"><span class="editable" contenteditable="true" data-type="number" onblur="validateAndUpdate(this)"></span></td><td class="border p-2 font-bold">0</td></tr>
                            <tr><td class="border p-2">KEC</td><td class="border p-2"><span class="editable" contenteditable="true" data-type="number" onblur="validateAndUpdate(this)"></span></td><td class="border p-2"><span class="editable" contenteditable="true" data-type="number" onblur="validateAndUpdate(this)"></span></td><td class="border p-2"><span class="editable" contenteditable="true" data-type="number" onblur="validateAndUpdate(this)"></span></td><td class="border p-2"><span class="editable" contenteditable="true" data-type="number" onblur="validateAndUpdate(this)"></span></td><td class="border p-2"><span class="editable" contenteditable="true" data-type="number" onblur="validateAndUpdate(this)"></span></td><td class="border p-2"><span class="editable" contenteditable="true" data-type="number" onblur="validateAndUpdate(this)"></span></td><td class="border p-2 font-bold">0</td></tr>
                            <tr><td class="border p-2">JS Mineing</td><td class="border p-2"><span class="editable" contenteditable="true" data-type="number" onblur="validateAndUpdate(this)"></span></td><td class="border p-2"><span class="editable" contenteditable="true" data-type="number" onblur="validateAndUpdate(this)"></span></td><td class="border p-2"><span class="editable" contenteditable="true" data-type="number" onblur="validateAndUpdate(this)"></span></td><td class="border p-2"><span class="editable" contenteditable="true" data-type="number" onblur="validateAndUpdate(this)"></span></td><td class="border p-2"><span class="editable" contenteditable="true" data-type="number" onblur="validateAndUpdate(this)"></span></td><td class="border p-2"><span class="editable" contenteditable="true" data-type="number" onblur="validateAndUpdate(this)"></span></td><td class="border p-2 font-bold">0</td></tr>
                            <tr><td class="border p-2">L&T – P1</td><td class="border p-2"><span class="editable" contenteditable="true" data-type="number" onblur="validateAndUpdate(this)"></span></td><td class="border p-2"><span class="editable" contenteditable="true" data-type="number" onblur="validateAndUpdate(this)"></span></td><td class="border p-2"><span class="editable" contenteditable="true" data-type="number" onblur="validateAndUpdate(this)"></span></td><td class="border p-2"><span class="editable" contenteditable="true" data-type="number" onblur="validateAndUpdate(this)"></span></td><td class="border p-2"><span class="editable" contenteditable="true" data-type="number" onblur="validateAndUpdate(this)"></span></td><td class="border p-2"><span class="editable" contenteditable="true" data-type="number" onblur="validateAndUpdate(this)"></span></td><td class="border p-2 font-bold">0</td></tr>
                            <tr><td class="border p-2">Others</td><td class="border p-2"><span class="editable" contenteditable="true" data-type="number" onblur="validateAndUpdate(this)"></span></td><td class="border p-2"><span class="editable" contenteditable="true" data-type="number" onblur="validateAndUpdate(this)"></span></td><td class="border p-2"><span class="editable" contenteditable="true" data-type="number" onblur="validateAndUpdate(this)"></span></td><td class="border p-2"><span class="editable" contenteditable="true" data-type="number" onblur="validateAndUpdate(this)"></span></td><td class="border p-2"><span class="editable" contenteditable="true" data-type="number" onblur="validateAndUpdate(this)"></span></td><td class="border p-2"><span class="editable" contenteditable="true" data-type="number" onblur="validateAndUpdate(this)"></span></td><td class="border p-2 font-bold">0</td></tr>
                            <tr>
                                <td class="border p-2 font-bold">Total</td>
                                <td class="border p-2 font-bold">0</td>
                                <td class="border p-2 font-bold">0</td>
                                <td class="border p-2 font-bold">0</td>
                                <td class="border p-2 font-bold">0</td>
                                <td class="border p-2 font-bold">0</td>
                                <td class="border p-2 font-bold">0</td>
                                <td class="border p-2 font-bold">0</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
               
                <!-- Stock Status -->
                <div class="bg-white p-4 rounded-lg shadow">
                    <h2 class="card-header text-lg font-semibold p-2 rounded-t-lg">Stock Status</h2>
                    <table class="w-full border-collapse">
                        <tbody>
                            <tr><td class="border p-2">10MM</td><td class="border p-2"><span class="editable" contenteditable="true" data-type="number" onblur="validateAndUpdate(this)"></span></td></tr>
                            <tr><td class="border p-2">20MM</td><td class="border p-2"><span class="editable" contenteditable="true" data-type="number" onblur="validateAndUpdate(this)"></span></td></tr>
                            <tr><td class="border p-2">RIVO</td><td class="border p-2"><span class="editable" contenteditable="true" data-type="number" onblur="validateAndUpdate(this)"></span></td></tr>
                            <tr><td class="border p-2">M-Sand</td><td class="border p-2"><span class="editable" contenteditable="true" data-type="number" onblur="validateAndUpdate(this)"></span></td></tr>
                            <tr><td class="border p-2">Railway Ballast (40–65MM)</td><td class="border p-2"><span class="editable" contenteditable="true" data-type="number" onblur="validateAndUpdate(this)"></span></td></tr>
                            <tr><td class="border p-2 font-bold">Total Stock</td><td class="border p-2 font-bold" id="stock-total">0</td></tr>
                            <tr><td class="border p-2">Boulder Stock at Quarry</td><td class="border p-2"><span class="editable" contenteditable="true" data-type="number" onblur="validateAndUpdate(this)"></span></td></tr>
                            <tr><td class="border p-2">Boulder Stock at Plant</td><td class="border p-2"><span class="editable" contenteditable="true" data-type="number" onblur="validateAndUpdate(this)"></span></td></tr>
                            <tr><td class="border p-2">Diesel Stock</td><td class="border p-2"><span class="editable" contenteditable="true" data-type="number" onblur="validateAndUpdate(this)"></span></td></tr>
                            <tr><td class="border p-2">Tire Stock</td><td class="border p-2"><span class="editable" contenteditable="true" data-type="number" onblur="validateAndUpdate(this)"></span></td></tr>
                        </tbody>
                    </table>
                </div>
               
                <!-- Equipment Update -->
                <div class="bg-white p-4 rounded-lg shadow">
                    <h2 class="card-header text-lg font-semibold p-2 rounded-t-lg">Equipment Update</h2>
                    <table class="w-full border-collapse">
                        <thead>
                            <tr>
                                <th class="border p-2 sticky">Equipment</th>
                                <th class="border p-2 sticky">Running</th>
                                <th class="border p-2 sticky">Idle</th>
                                <th class="border p-2 sticky">Remarks</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td class="border p-2">Tippers</td>
                                <td class="border p-2"><span class="editable" contenteditable="true" data-type="number" onblur="validateAndUpdate(this)"></span></td>
                                <td class="border p-2"><span class="editable" contenteditable="true" data-type="number" onblur="validateAndUpdate(this)"></span></td>
                                <td class="border p-2"><span class="editable" contenteditable="true"></span></td>
                            </tr>
                            <tr>
                                <td class="border p-2">Excavators Working</td>
                                <td class="border p-2"><span class="editable" contenteditable="true" data-type="number" onblur="validateAndUpdate(this)"></span></td>
                                <td class="border p-2"><span class="editable" contenteditable="true" data-type="number" onblur="validateAndUpdate(this)"></span></td>
                                <td class="border p-2"><span class="editable" contenteditable="true"></span></td>
                            </tr>
                            <tr>
                                <td class="border p-2">Loaders Working</td>
                                <td class="border p-2"><span class="editable" contenteditable="true" data-type="number" onblur="validateAndUpdate(this)"></span></td>
                                <td class="border p-2"><span class="editable" contenteditable="true" data-type="number" onblur="validateAndUpdate(this)"></span></td>
                                <td class="border p-2"><span class="editable" contenteditable="true"></span></td>
                            </tr>
                            <tr>
                                <td class="border p-2">Total Trips of Tippers</td>
                                <td class="border p-2" colspan="3"><span class="editable" contenteditable="true" data-type="number" onblur="validateAndUpdate(this)"></span></td>
                            </tr>
                            <tr>
                                <td class="border p-2">Total Tonnage Moved</td>
                                <td class="border p-2" colspan="3"><span class="editable" contenteditable="true" data-type="number" onblur="validateAndUpdate(this)"></span></td>
                            </tr>
                            <tr>
                                <td class="border p-2">Excavator Working Hours</td>
                                <td class="border p-2" colspan="3"><span class="editable" contenteditable="true" data-type="number" onblur="validateAndUpdate(this)"></span></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
               
                <!-- Fund Requirement & Collection Plan -->
                <div class="bg-white p-4 rounded-lg shadow md:col-span-2">
                    <h2 class="card-header text-lg font-semibold p-2 rounded-t-lg">Fund Requirement & Collection Plan</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <h3 class="font-bold mb-2">Fund Requirement</h3>
                            <table class="w-full border-collapse" id="fund-requirement-table">
                                <thead>
                                    <tr>
                                        <th class="border p-2">Vendor Name</th>
                                        <th class="border p-2">Amount</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr><td class="border p-2"><span class="editable" contenteditable="true"></span></td><td class="border p-2"><span class="editable" contenteditable="true" data-type="number" onblur="validateAndUpdate(this)"></span></td></tr>
                                    <tr><td class="border p-2"><span class="editable" contenteditable="true"></span></td><td class="border p-2"><span class="editable" contenteditable="true" data-type="number" onblur="validateAndUpdate(this)"></span></td></tr>
                                    <tr><td class="border p-2"><span class="editable" contenteditable="true"></span></td><td class="border p-2"><span class="editable" contenteditable="true" data-type="number" onblur="validateAndUpdate(this)"></span></td></tr>
                                    <tr><td class="border p-2"><span class="editable" contenteditable="true"></span></td><td class="border p-2"><span class="editable" contenteditable="true" data-type="number" onblur="validateAndUpdate(this)"></span></td></tr>
                                    <tr><td class="border p-2"><span class="editable" contenteditable="true"></span></td><td class="border p-2"><span class="editable" contenteditable="true" data-type="number" onblur="validateAndUpdate(this)"></span></td></tr>
                                    <tr><td class="border p-2"><span class="editable" contenteditable="true"></span></td><td class="border p-2"><span class="editable" contenteditable="true" data-type="number" onblur="validateAndUpdate(this)"></span></td></tr>
                                </tbody>
                                <tfoot>
                                    <tr>
                                        <td class="border p-2 font-bold">Total Fund Requirement</td>
                                        <td class="border p-2 font-bold" id="fund-total">0</td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                        <div>
                            <h3 class="font-bold mb-2">Expected Collection</h3>
                            <table class="w-full border-collapse" id="collection-table">
                                <thead>
                                    <tr>
                                        <th class="border p-2">Customer Name</th>
                                        <th class="border p-2">Amount</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr><td class="border p-2"><span class="editable" contenteditable="true"></span></td><td class="border p-2"><span class="editable" contenteditable="true" data-type="number" onblur="validateAndUpdate(this)"></span></td></tr>
                                    <tr><td class="border p-2"><span class="editable" contenteditable="true"></span></td><td class="border p-2"><span class="editable" contenteditable="true" data-type="number" onblur="validateAndUpdate(this)"></span></td></tr>
                                    <tr><td class="border p-2"><span class="editable" contenteditable="true"></span></td><td class="border p-2"><span class="editable" contenteditable="true" data-type="number" onblur="validateAndUpdate(this)"></span></td></tr>
                                    <tr><td class="border p-2"><span class="editable" contenteditable="true"></span></td><td class="border p-2"><span class="editable" contenteditable="true" data-type="number" onblur="validateAndUpdate(this)"></span></td></tr>
                                    <tr><td class="border p-2"><span class="editable" contenteditable="true"></span></td><td class="border p-2"><span class="editable" contenteditable="true" data-type="number" onblur="validateAndUpdate(this)"></span></td></tr>
                                    <tr><td class="border p-2"><span class="editable" contenteditable="true"></span></td><td class="border p-2"><span class="editable" contenteditable="true" data-type="number" onblur="validateAndUpdate(this)"></span></td></tr>
                                </tbody>
                                <tfoot>
                                    <tr>
                                        <td class="border p-2 font-bold">Total Expected Collection</td>
                                        <td class="border p-2 font-bold" id="collection-total">0</td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Task Management Section -->
        <div class="max-w-7xl mx-auto mt-8">
            <h2 class="text-2xl font-bold text-center mb-4">Task Management</h2>
            <div class="grid grid-cols-1 md:grid-cols-5 gap-6">
                <div class="bg-white p-4 rounded-lg shadow text-center font-bold">Quarry</div>
                <div class="bg-white p-4 rounded-lg shadow text-center font-bold">Plant Maintenance</div>
                <div class="bg-white p-4 rounded-lg shadow text-center font-bold">Arun Sir</div>
                <div class="bg-white p-4 rounded-lg shadow text-center font-bold">Jagan Sir</div>
                <div class="bg-white p-4 rounded-lg shadow text-center font-bold">Others</div>
            </div>
            <a href="https://bimal-bp.github.io/SGX_Aggregate_WEB/" class="big-button">View Main Web</a>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // ---------- DOM ----------
            const loginPage = document.getElementById('loginPage');
            const dashboardPage = document.getElementById('dashboardPage');
            const welcomeMessage = document.getElementById('welcomeMessage');
            const logoutBtn = document.getElementById('logoutBtn');
            const usernameInput = document.getElementById('username');
            const passwordInput = document.getElementById('password');
            const loginForm = document.getElementById('loginForm');
            const loginBtn = document.getElementById('loginBtn');
            const cameraPreview = document.getElementById('cameraPreview');
            const captureOverlay = document.getElementById('captureOverlay');
            const capturedPhoto = document.getElementById('capturedPhoto');
            const loginDetails = document.getElementById('loginDetails');
            const locationStatus = document.getElementById('locationStatus');
            const locationNameEl = document.getElementById('locationName');
            const locationOptions = document.getElementById('locationOptions');
            const retryBtn = document.getElementById('retryLocation');
            const approxBtn = document.getElementById('useApproximateLocation');
            const skipBtn = document.getElementById('skipLocation');

            // ---------- STATE ----------
            let currentStream = null;
            let isCameraActive = false;
            let userLocation = null;
            let locationAcquired = false;
            let locationType = 'none';

            // ---------- EMPLOYEE DB ----------
            const employees = {
                'sgxminerals': { password: 'admin123', name: 'Bimal Patra', role: 'Operations Manager' },
                'jdoe': { password: 'mineral2023', name: 'Jane Doe', role: 'Geologist' },
                'rsmith': { password: 'extraction22', name: 'Robert Smith', role: 'Field Supervisor' }
            };

            // Pre-fill demo
            usernameInput.value = 'sgxminerals';
            passwordInput.value = 'admin123';

            // ---------- CAMERA ----------
            function startCamera() {
                if (currentStream) stopCamera();
                navigator.mediaDevices.getUserMedia({
                    video: { width: { ideal: 640 }, height: { ideal: 480 } },
                    audio: false
                })
                .then(stream => {
                    currentStream = stream;
                    cameraPreview.srcObject = stream;
                    isCameraActive = true;
                })
                .catch(err => {
                    console.error('Camera error:', err);
                    alert('Camera access denied or unavailable.');
                });
            }

            function stopCamera() {
                if (currentStream) {
                    currentStream.getTracks().forEach(t => t.stop());
                    currentStream = null;
                    isCameraActive = false;
                }
            }

            // ---------- LOCATION ----------
            function requestLocation() {
                locationStatus.innerHTML = '<div class="spinner"></div> Getting your location…';
                locationStatus.className = 'location-status waiting';
                locationOptions.style.display = 'none';
                locationAcquired = false;
                locationType = 'none';
                loginBtn.disabled = true;

                if (!navigator.geolocation) {
                    locationFailed('Geolocation not supported by your browser.');
                    return;
                }

                const highAccuracyOptions = { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 };
                navigator.geolocation.getCurrentPosition(
                    pos => handleLocationSuccess(pos, 'high'),
                    err => {
                        const lowAccuracyOptions = { enableHighAccuracy: false, timeout: 10000, maximumAge: 60000 };
                        navigator.geolocation.getCurrentPosition(
                            pos => handleLocationSuccess(pos, 'approximate'),
                            handleLocationError,
                            lowAccuracyOptions
                        );
                    },
                    highAccuracyOptions
                );
            }

            function handleLocationSuccess(position, accuracy) {
                userLocation = {
                    lat: position.coords.latitude,
                    lon: position.coords.longitude,
                    acc: position.coords.accuracy,
                    timestamp: new Date(position.timestamp)
                };
                locationAcquired = true;
                locationType = accuracy;
                loginBtn.disabled = false;

                if (accuracy === 'high') {
                    locationStatus.innerHTML = 'High accuracy location captured';
                    locationStatus.className = 'location-status success';
                } else {
                    locationStatus.innerHTML = 'Approximate location captured';
                    locationStatus.className = 'location-status warning';
                }
                reverseGeocode(userLocation.lat, userLocation.lon);
            }

            function handleLocationError(error) {
                let msg = 'Failed to get location.';
                switch(error.code) {
                    case error.PERMISSION_DENIED: msg = 'Location permission denied.'; break;
                    case error.POSITION_UNAVAILABLE: msg = 'Location information unavailable.'; break;
                    case error.TIMEOUT: msg = 'Location request timed out.'; break;
                }
                locationFailed(msg);
            }

            function locationFailed(message) {
                userLocation = null;
                locationAcquired = false;
                locationType = 'none';
                loginBtn.disabled = true;
                locationStatus.innerHTML = `${message}`;
                locationStatus.className = 'location-status error';
                locationOptions.style.display = 'flex';
                locationNameEl.textContent = '';
            }

            function useApproximateLocation() {
                locationStatus.innerHTML = '<div class="spinner"></div> Getting approximate location…';
                locationStatus.className = 'location-status waiting';
                locationOptions.style.display = 'none';

                fetch('https://ipapi.co/json/')
                    .then(r => r.json())
                    .then(data => {
                        userLocation = { lat: data.latitude, lon: data.longitude, acc: 50000, timestamp: new Date() };
                        locationAcquired = true;
                        locationType = 'approximate';
                        loginBtn.disabled = false;
                        locationStatus.innerHTML = 'Approximate location (IP-based)';
                        locationStatus.className = 'location-status warning';
                        locationNameEl.textContent = ` ${data.city}, ${data.region}, ${data.country_name}`;
                    })
                    .catch(() => locationFailed('Could not determine approximate location.'));
            }

            function skipLocation() {
                locationAcquired = false;
                locationType = 'none';
                loginBtn.disabled = false;
                locationStatus.innerHTML = 'Location not captured - Limited access';
                locationStatus.className = 'location-status warning';
                locationOptions.style.display = 'none';
                locationNameEl.textContent = '';
            }

            async function reverseGeocode(lat, lon) {
                try {
                    const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&zoom=18&addressdetails=1`);
                    const data = await res.json();
                    locationNameEl.textContent = ` ${data.display_name || `${lat.toFixed(6)}, ${lon.toFixed(6)}`}`;
                } catch {
                    locationNameEl.textContent = ` ${lat.toFixed(6)}, ${lon.toFixed(6)}`;
                }
            }

            // ---------- CAPTURE ----------
            async function captureImage() {
                if (!isCameraActive) return null;
                captureOverlay.classList.add('active');
                await new Promise(r => setTimeout(r, 1000));
                const canvas = document.createElement('canvas');
                canvas.width = cameraPreview.videoWidth || 640;
                canvas.height = cameraPreview.videoHeight || 480;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(cameraPreview, 0, 0, canvas.width, canvas.height);
                const dataUrl = canvas.toDataURL('image/jpeg', 0.9);
                captureOverlay.classList.remove('active');
                return dataUrl;
            }

            // ---------- LOGIN ----------
            async function loginSuccess(name) {
                const photo = await captureImage();
                loginPage.style.display = 'none';
                dashboardPage.style.display = 'block';
                welcomeMessage.textContent = `Welcome, ${name}!`;

                if (photo) capturedPhoto.src = photo;
                else capturedPhoto.alt = 'Photo capture failed';

                const now = new Date();
                const locationInfo = userLocation ? `<p><strong>Location:</strong> ${locationNameEl.textContent || 'Unknown'}</p>` : '<p><strong>Location:</strong> Not captured</p>';
                loginDetails.innerHTML = `
                    <p><strong>User:</strong> ${name}</p>
                    <p><strong>Login Time:</strong> ${now.toLocaleString()}</p>
                    ${locationInfo}
                `;
            }

            function handleLogin() {
                if (!locationAcquired && locationType === 'none') {
                    alert('Location is required for full system access.');
                    return;
                }
                const username = usernameInput.value.trim();
                const password = passwordInput.value;
                if (employees[username] && employees[username].password === password) {
                    loginSuccess(employees[username].name);
                } else {
                    alert('Invalid credentials.\n\nDemo:\nUsername: sgxminerals\nPassword: admin123');
                }
            }

            // ---------- LOGOUT ----------
            function logout() {
                loginPage.style.display = 'flex';
                dashboardPage.style.display = 'none';
                usernameInput.value = 'sgxminerals';
                passwordInput.value = 'admin123';
                capturedPhoto.src = '';
                loginDetails.innerHTML = '';
                locationNameEl.textContent = '';
                locationStatus.innerHTML = '<div class="spinner"></div> Getting your location…';
                locationStatus.className = 'location-status waiting';
                locationOptions.style.display = 'none';
                loginBtn.disabled = true;
                startCamera();
                requestLocation();
            }

            // ---------- EVENT LISTENERS ----------
            loginForm.addEventListener('submit', e => { e.preventDefault(); handleLogin(); });
            logoutBtn.addEventListener('click', logout);
            retryBtn.addEventListener('click', requestLocation);
            approxBtn.addEventListener('click', useApproximateLocation);
            skipBtn.addEventListener('click', skipLocation);

            [usernameInput, passwordInput].forEach(input => {
                input.addEventListener('focus', () => loginForm.classList.add('glow'));
                input.addEventListener('blur', () => {
                    if (!usernameInput.matches(':focus') && !passwordInput.matches(':focus')) {
                        loginForm.classList.remove('glow');
                    }
                });
            });

            // ---------- INITIALIZATION ----------
            startCamera();
            requestLocation();
        });

        // Dashboard Functions
        function updateDate(newDate) { document.getElementById('dashboard-date').textContent = newDate; }
        function validateAndUpdate(el) {
            const val = el.textContent ? el.textContent.trim() : el.value;
            if (el.dataset.type === 'number' && isNaN(parseFloat(val))) el.classList.add('error');
            else el.classList.remove('error');
            updateTotals();
        }

        function updateTotals() {
            // Royalty
            let royaltyTotal = 0;
            document.querySelectorAll('#royalty-table .editable').forEach(c => royaltyTotal += parseFloat(c.textContent) || 0);
            document.getElementById('royalty-total').textContent = royaltyTotal.toFixed(1);
            document.getElementById('royalty-grand-total').textContent = royaltyTotal.toFixed(1);

            // Dispatch
            const dispatchRows = document.querySelectorAll('#dispatch-table tbody tr:not(:last-child)');
            const colTotals = Array(6).fill(0);
            let grandTotal = 0;
            dispatchRows.forEach(row => {
                let rowTotal = 0;
                row.querySelectorAll('.editable').forEach((c, i) => {
                    const v = parseFloat(c.textContent) || 0;
                    rowTotal += v; colTotals[i] += v;
                });
                row.querySelector('td:last-child').textContent = rowTotal;
                grandTotal += rowTotal;
            });
            const totalRow = document.querySelector('#dispatch-table tbody tr:last-child');
            totalRow.querySelectorAll('td:not(:first-child):not(:last-child)').forEach((td, i) => td.textContent = colTotals[i]);
            totalRow.querySelector('td:last-child').textContent = grandTotal;

            // Stock
            let stockTotal = 0;
            document.querySelectorAll('#stock-total').forEach(t => {
                const rows = t.closest('table').querySelectorAll('tr:nth-child(-n+5) .editable');
                stockTotal = Array.from(rows).reduce((s, c) => s + (parseFloat(c.textContent) || 0), 0);
                t.textContent = stockTotal;
            });

            // Fund & Collection
            ['fund-requirement-table', 'collection-table'].forEach(id => {
                let total = 0;
                document.querySelectorAll(`#${id} tbody .editable[data-type="number"]`).forEach(c => total += parseFloat(c.textContent) || 0);
                document.querySelector(`#${id} tfoot td:last-child`).textContent = total;
            });
        }

        function exportCSV() {
            let csv = '';
            document.querySelectorAll('table').forEach((t, i) => {
                csv += `Table ${i+1}\n`;
                Array.from(t.rows).forEach(r => csv += Array.from(r.cells).map(c => c.textContent.trim()).join(',') + '\n');
                csv += '\n';
            });
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = 'dashboard.csv'; a.click();
        }

        function exportExcel() {
            if (typeof XLSX === 'undefined') { exportCSV(); return; }
            const wb = XLSX.utils.book_new();
            document.querySelectorAll('table').forEach((t, i) => {
                const ws = XLSX.utils.table_to_sheet(t);
                XLSX.utils.book_append_sheet(wb, ws, `Sheet${i+1}`);
            });
            XLSX.writeFile(wb, 'dashboard.xlsx');
        }

        function printDashboard() {
            document.querySelector('.flex.justify-between').style.display = 'none';
            window.print();
            document.querySelector('.flex.justify-between').style.display = 'flex';
        }

        updateTotals();
        document.addEventListener('keydown', e => {
            if (e.target.classList.contains('editable') && e.key === 'Enter') {
                e.preventDefault(); e.target.blur();
            }
        });
    </script>
</body>
</html>
